<!DOCTYPE html>
<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.1.1/pdfobject.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jsforce/1.9.1/jsforce.min.js"></script>
<script src="rblogo.js"></script>
<script
			  src="https://code.jquery.com/jquery-3.4.1.min.js"
			  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			  crossorigin="anonymous"></script>
  <script>
jsforce.browser.init({
  clientId: '3MVG96mGXeuuwTZj4ok0CcM5RIpNllDP5dKcxvgyJRi8Qr0qhWSNCvUtKEXG80br3fFQyCjfcce.2CHgc_TWA',
  redirectUri: 'http://localhost/sftest.html',
loginUrl : 'https://reddbarna--rbit.cs84.my.salesforce.com/',
     proxyUrl: 'https://node-salesforce-proxy.herokuapp.com/proxy/'
});

function findGetParameter(parameterName) {
    var result = null,
        tmp = [];
    var items = location.search.substr(1).split("&");
    for (var index = 0; index < items.length; index++) {
        tmp = items[index].split("=");
        if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
    }
    return result;
}
function tolog(text){
$("#log").append(text + "<br>");
};

var conn;
var recid;
var docs = {};
$(function() {
  if (jsforce.browser.isLoggedIn()) {
    tolog('logged in');
    $('#loginBtn').hide();
    $('#logoutBtn').show();
    conn = jsforce.browser.connection;
    startQuery();
  } else {
    tolog('not logged in');
    $('#logoutBtn').hide();
    jsforce.browser.on('connect', function(_conn) {
      tolog('connected', _conn);
      $('#loginBtn').hide();
      $('#logoutBtn').show();
      conn = _conn;
      startQuery();
    });
  }
});

function startQuery() {
  tolog("start query...");

conn.query("SELECT Id, Name FROM Account LIMIT 6", function(err, res) {
  if (err) { return handleError(err); }
  tolog("found "+ res.totalSize + " records");
  handleResult(res);
});

}

function handleResult(res){
tolog("handle result...");
var records = res.records;

records.forEach(function(item, index, arr) {
var doc = new jsPDF();
  doc.text(item.Name, 20, 20);
  docs[item.Id] = doc;
} )
}


function login(res) {
  jsforce.browser.login(function(err, res) {
    tolog(err ? err.message : res.status);
  });
}
function logout(res) {
  jsforce.browser.logout();
  location.reload();
}

$(document).on("click", "#dlpdf", function(){
  docs[Object.keys(docs)[currentdoc]].save(Object.keys(docs)[currentdoc] + ".pdf");
});
var currentdoc = -1;
$(document).on("click", "#debug", function(){
  if (currentdoc < Object.keys(docs).length -1){
  currentdoc++;
 } else {
  currentdoc = 0;
}
  console.log(docs);
  PDFObject.embed(docs[Object.keys(docs)[currentdoc]].output('datauristring'), "#content");
  tolog("Rendering " + (currentdoc + 1) + "/" + Object.keys(docs).length);  


});
$(document).on("click", "#dlallpdf", function(){
Object.keys(docs).forEach(function (key){
    docs[key].save(key + ".pdf");
});
  
});


    </script>
  </head>
  <body>
    <div>
      <button id="reloadBtn" onclick="location.reload()">Reload</button>
      <button id="loginBtn" onclick="login()">Login</button>
      <button id="logoutBtn" onclick="logout()">Logout</button>
      <button id="dlpdf">Download PDF</button>
      <button id="dlallpdf">Download all PDFs</button>
<button id="debug">Loop through Docs</button>
    </div>
    <div id="log"></div>
    <div id="content" style="height: 850px; width:600px;"> </div>
  </body>
</html>
